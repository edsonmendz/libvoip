<!DOCTYPE html>
<html lang="pt-br" data-theme="cyberpunk">
<pre style="display:none;">
 ___________________________________________________________________________
|  _______________________________________________________________________  |
| /                                                                       \ |
| |   _____  ____  _    _             _____    _____  ___   _____         | |
| |  / ____|/ __ \| |  | |    /\     |  __ \  |  __ \|__ \ |  __ \        | |
| | | (___ | |  | | |  | |   /  \    | |  | | | |__) |  ) || |__) |       | |
| |  \___ \| |  | | |  | |  / /\ \   | |  | | |  ___/  / / |  ___/        | |
| |  ____) | |__| | |__| | / ____ \  | |__| | | |     / /_ | |            | |
| | |_____/ \___\_\\____/ /_/    \_\ |_____/  |_|    |____||_|            | |
| |                                                                       | |
| \_______________________________________________________________________/ |
|___________________________________________________________________________|
|                                                                           |
|  [ PHILOSOPHY ] ......................................................... |
|                                                                           |
|  * PRIVACY FIRST: No middleman. Your data, your rules.                    |
|  * LOW RESOURCE: Built to run light, leaving power for what matters.      |
|  * PURE TRUST: Created as a response to Discord's evolving data rules.    |
|                                                                           |
|  [ THE P2P MANIFESTO ] .................................................. |
|                                                                           |
|  Squad P2P was born from the need for true digital sovereignty. While     |
|  big platforms shift their policies, we return to the roots.              |
|                                                                           |
|  [!] WARNING: This is a Peer-to-Peer environment.                         |
|  BENEFITS: Total privacy, no central server lag, no corporate spying.     |
|  BURDENS: Your IP is visible to those you connect with.                   |
|                                                                           |
|  >> USE ONLY WITH TRUSTED FRIENDS. CHOOSE YOUR SQUAD WISELY. <<           |
|___________________________________________________________________________|
|                                                                           |
|  CREATED: 2026-02-15                                     BY: N4th4nBR     |
|___________________________________________________________________________|
</pre>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQUAD P2P v1.4</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- ENGINE VISUAL --- */
        [data-theme="cyberpunk"] { --bg-body:#050505; --bg-panel:#0b0b10; --bg-input:#12121a; --primary:#00ff9d; --primary-glow:rgba(0,255,157,0.3); --text-main:#e0e0e0; --text-dim:#6e6e7a; --border:#2a2a35; --radius:4px; --font-ui:'Rajdhani',sans-serif; --bg-pattern:linear-gradient(rgba(0,255,157,0.05) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,157,0.05) 1px,transparent 1px); --bg-size:30px 30px; }
        [data-theme="vaporwave"] { --bg-body:#1a0029; --bg-panel:#240038; --bg-input:#360052; --primary:#ff71ce; --primary-glow:rgba(255,113,206,0.5); --text-main:#fff0f5; --text-dim:#b569d6; --border:#5e187a; --radius:15px; --font-ui:'Inter',sans-serif; --bg-pattern:radial-gradient(circle at center bottom,rgba(255,200,0,0.2) 0%,transparent 60%),repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(1,205,254,0.1) 3px); --bg-size:100% 100%,100% 4px; }
        [data-theme="dracula"]   { --bg-body:#282a36; --bg-panel:#21222c; --bg-input:#44475a; --primary:#bd93f9; --primary-glow:rgba(189,147,249,0.2); --text-main:#f8f8f2; --text-dim:#6272a4; --border:#44475a; --radius:8px; --font-ui:'Inter',sans-serif; --bg-pattern:none; }
        [data-theme="matrix"]    { --bg-body:#000000; --bg-panel:#050f05; --bg-input:#001a00; --primary:#00ff00; --primary-glow:rgba(0,255,0,0.4); --text-main:#ccffcc; --text-dim:#005500; --border:#003300; --radius:0px; --font-ui:'Share Tech Mono',monospace; --bg-pattern:linear-gradient(0deg,rgba(0,20,0,0.9),rgba(0,0,0,1)); --bg-size:100% 100%; }
        [data-theme="ocean"]     { --bg-body:#0f172a; --bg-panel:rgba(30,41,59,0.9); --bg-input:rgba(51,65,85,0.7); --primary:#38bdf8; --primary-glow:rgba(56,189,248,0.3); --text-main:#f1f5f9; --text-dim:#94a3b8; --border:rgba(148,163,184,0.2); --radius:12px; --font-ui:'Inter',sans-serif; --bg-pattern:radial-gradient(circle at top right,#1e40af,transparent 60%); --bg-size:100% 100%; }
        [data-theme="light"]     { --bg-body:#f5f5f7; --bg-panel:#ffffff; --bg-input:#eef0f2; --primary:#007aff; --primary-glow:rgba(0,122,255,0.15); --text-main:#1d1d1f; --text-dim:#86868b; --border:#d2d2d7; --radius:18px; --font-ui:'Inter',sans-serif; --bg-pattern:none; }

        * { margin:0; padding:0; box-sizing:border-box; transition:all 0.3s cubic-bezier(0.25,0.8,0.25,1); }
        body { font-family:var(--font-ui); background-color:var(--bg-body); color:var(--text-main); height:100vh; overflow:hidden; background-image:var(--bg-pattern); background-size:var(--bg-size); background-attachment:fixed; }

        /* UI GERAL */
        .btn-start { background:var(--primary); color:var(--bg-body); border:none; padding:12px; font-family:var(--font-ui); font-size:1rem; font-weight:bold; cursor:pointer; border-radius:var(--radius); width:100%; margin-top:15px; box-shadow:0 4px 15px var(--primary-glow); }
        .btn-start:hover { transform:translateY(-2px); filter:brightness(1.1); }
        .modern-input { width:100%; padding:14px; background:var(--bg-input); border:1px solid var(--border); color:var(--text-main); border-radius:var(--radius); outline:none; font-family:var(--font-ui); }
        .modern-input:focus { border-color:var(--primary); box-shadow:0 0 10px var(--primary-glow); }

        /* LAYOUT */
        .app-container { display:grid; grid-template-columns:1fr 340px; height:100vh; }
        .app-container.chat-closed { grid-template-columns:1fr 0px; }
        .sidebar { background:var(--bg-panel); border-left:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; backdrop-filter:blur(20px); z-index:20; padding:15px; }
        .main { display:flex; flex-direction:column; height:100vh; position:relative; }

        /* TOP BAR */
        .top-bar { height:75px; padding:0 25px; display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.1); border-bottom:1px solid var(--border); backdrop-filter:blur(5px); }
        .app-logo { display:flex; align-items:center; gap:10px; font-family:'Rajdhani',sans-serif; font-size:1.5rem; font-weight:800; color:var(--text-main); letter-spacing:2px; }
        .app-logo span { color: var(--primary); }
        .controls { display:flex; gap:12px; background:var(--bg-panel); padding:8px 20px; border-radius:50px; border:1px solid var(--border); box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        .btn-icon { width:42px; height:42px; border-radius:50%; border:none; background:transparent; color:var(--text-dim); font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .btn-icon:hover { color:var(--primary); background:var(--bg-input); transform:scale(1.1); }
        .btn-icon.active-red { background:#ff4757; color:white; box-shadow:0 0 15px rgba(255,71,87,0.4); }
        .btn-icon.active-green { background:var(--primary); color:var(--bg-body); box-shadow:0 0 15px var(--primary-glow); }
        .toggle-chat { background:var(--bg-panel); border:1px solid var(--border); color:var(--text-main); width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; position:absolute; right:20px; top:90px; z-index:100; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
        .chat-closed .toggle-chat { right:10px; transform:rotate(180deg); }

        /* VIDEO AREA */
        .grid { flex:1; padding:25px; display:flex; flex-wrap:wrap; justify-content:center; align-content:center; gap:20px; overflow-y:auto; }
        .card { background:#000; border:2px solid var(--border); border-radius:var(--radius); overflow:hidden; position:relative; aspect-ratio:16/9; width:100%; max-width:600px; min-width:300px; flex-grow:1; box-shadow:0 15px 40px rgba(0,0,0,0.4); animation:fadeIn 0.5s ease; }
        .grid:has(.card:only-child) .card { max-width:900px; max-height:80vh; }
        video { width:100%; height:100%; object-fit:cover; }
        
        .avatar-view { position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-panel); display:none; align-items:center; justify-content:center; z-index:2; }
        .card.cam-off .avatar-view { display:flex; }
        .big-avatar { width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid var(--primary); box-shadow:0 0 25px var(--primary-glow); }
        .label { position:absolute; bottom:15px; left:15px; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); padding:6px 14px; border-radius:var(--radius); font-size:0.85rem; color:white; font-weight:bold; border:1px solid var(--border); display:flex; align-items:center; gap:8px; z-index:5; }
        .mini-avatar { width:24px; height:24px; border-radius:50%; object-fit:cover; }

        /* SIDEBAR & ID BOX */
        .panel { padding:15px; border-radius:var(--radius); background:var(--bg-input); border:1px solid var(--border); margin-bottom:15px; }
        
        .id-container { display: flex; gap: 8px; margin-top: 10px; }
        .id-box { 
            flex: 1; background:rgba(0,0,0,0.2); padding:12px; border-radius:var(--radius); 
            font-family:monospace; font-size:0.9em; border:1px dashed var(--border); 
            color:var(--primary); font-weight:bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .btn-copy {
            background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-dim);
            width: 40px; border-radius: var(--radius); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-copy:hover { border-color: var(--primary); color: var(--primary); background: var(--bg-input); }
        .btn-copy:active { background: var(--primary); color:black; }
        
        .btn-exit { width:100%; margin-top:10px; background:transparent; color:#ff4757; border:1px solid #ff4757; padding:8px; border-radius:var(--radius); cursor:pointer; font-size:0.8rem; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:5px; }
        .btn-exit:hover { background:rgba(255,71,87,0.1); }
        .btn-reconnect { width:100%; margin-top:5px; background:var(--bg-panel); color:var(--text-dim); border:1px dashed var(--border); padding:10px; border-radius:var(--radius); cursor:pointer; font-size:0.8rem; display:none; align-items:center; justify-content:center; gap:5px; }
        .btn-reconnect:hover { border-color:var(--primary); color:var(--primary); }

        .chat-area { flex:1; overflow-y:auto; padding:0 5px; display:flex; flex-direction:column; gap:12px; margin-bottom:15px; }
        .msg { padding:12px; background:var(--bg-input); border-radius:var(--radius); font-size:0.9rem; border-left:3px solid transparent; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        .msg-header { font-size:0.75rem; color:var(--text-dim); margin-bottom:5px; font-weight:bold; display:flex; align-items:center; gap:8px; }
        .my-msg { align-self:flex-end; background:var(--primary-glow); border:1px solid var(--primary); text-align:right; }
        .my-msg .msg-header { justify-content:flex-end; color:var(--text-main); }
        .chat-input-box { display:flex; gap:10px; align-items:center; background:var(--bg-input); padding:10px; border-radius:var(--radius); border:1px solid var(--border); }
        .btn-file { background:transparent; border:none; color:var(--text-dim); font-size:1.2rem; cursor:pointer; padding:5px; }
        .btn-file:hover { color:var(--primary); transform:scale(1.1); }
        .chat-img { max-width:100%; border-radius:var(--radius); margin-top:8px; border:1px solid var(--border); cursor:pointer; }

        /* MODAIS */
        .login-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-body); background-image:var(--bg-pattern); background-size:var(--bg-size); z-index:5000; display:flex; justify-content:center; align-items:center; }
        .login-box { background:var(--bg-panel); padding:50px; border-radius:24px; border:1px solid var(--border); box-shadow:0 30px 80px rgba(0,0,0,0.7); text-align:center; width:400px; backdrop-filter:blur(15px); }
        .avatar-upload { width:120px; height:120px; border-radius:50%; background:var(--bg-input); margin:0 auto 25px; border:3px dashed var(--primary); display:flex; justify-content:center; align-items:center; cursor:pointer; overflow:hidden; }
        .avatar-upload:hover { border-color:var(--text-main); box-shadow:0 0 25px var(--primary-glow); }
        .avatar-upload img { width:100%; height:100%; object-fit:cover; }

        .config-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:6000; }
        .config-box { background:var(--bg-panel); padding:40px; border-radius:20px; width:600px; border:1px solid var(--border); box-shadow:0 20px 60px rgba(0,0,0,0.9); }
        
        .theme-selector { display:flex; gap:20px; margin-top:20px; justify-content:center; flex-wrap:wrap; }
        .theme-option-container { display:flex; flex-direction:column; align-items:center; gap:8px; }
        .theme-btn { width:50px; height:50px; border-radius:50%; cursor:pointer; border:2px solid rgba(255,255,255,0.1); transition:0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .theme-btn:hover { transform:scale(1.1); border-color:var(--primary); }
        .theme-btn.selected { border-color:var(--text-main); transform:scale(1.15); box-shadow:0 0 20px var(--primary-glow); }
        .theme-label { font-size:0.75rem; color:var(--text-dim); font-weight:bold; text-transform:uppercase; letter-spacing:1px; }

        /* Cores Temas */
        .t-cyberpunk { background-color:#00ff9d; } .t-vaporwave { background-color:#ff71ce; } .t-dracula { background-color:#bd93f9; }
        .t-matrix { background-color:#00ff00; } .t-ocean { background-color:#38bdf8; } .t-light { background-color:#ffffff; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <div class="login-overlay" id="loginScreen">
        <div class="login-box">
            <div style="font-family:'Rajdhani'; font-size:3rem; margin-bottom:5px; color:var(--text-main); text-shadow:0 0 20px var(--primary-glow);">
                <i class="fas fa-bolt" style="color:var(--primary);"></i> SQUAD P2P
            </div>
            <p style="color:var(--text-dim); font-size:0.9rem; margin-bottom:30px; letter-spacing:3px; font-weight:bold;">MESH NETWORK</p>
            <label class="avatar-upload" title="Clique para trocar foto">
                <img id="avatarPreview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                <input type="file" id="avatarFile" accept="image/*" style="display:none;" onchange="carregarAvatar(this)">
            </label>
            <input type="text" id="start-nick" class="modern-input" placeholder="Seu Nickname..." style="text-align:center; font-size:1.1rem; padding:15px;">
            <button class="btn-start" onclick="iniciarAplicacao()">ENTRAR NA SALA</button>
        </div>
    </div>

    <div class="config-overlay" id="configScreen">
        <div class="config-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2 style="color:var(--text-main); font-family:'Rajdhani'; letter-spacing:1px;">CONFIGURAÇÕES</h2>
                <button onclick="fecharConfig()" style="background:none; border:none; color:var(--text-dim); cursor:pointer;"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <label style="color:var(--primary); font-size:0.8rem; font-weight:bold; display:block; text-align:center; letter-spacing:1px;">ESTILO VISUAL</label>
            <div class="theme-selector">
                <div class="theme-option-container"><div class="theme-btn t-cyberpunk selected" onclick="mudarTema('cyberpunk')"></div><span class="theme-label">Cyber</span></div>
                <div class="theme-option-container"><div class="theme-btn t-vaporwave" onclick="mudarTema('vaporwave')"></div><span class="theme-label">Vapor</span></div>
                <div class="theme-option-container"><div class="theme-btn t-dracula" onclick="mudarTema('dracula')"></div><span class="theme-label">Drac</span></div>
                <div class="theme-option-container"><div class="theme-btn t-matrix" onclick="mudarTema('matrix')"></div><span class="theme-label">Matrix</span></div>
                <div class="theme-option-container"><div class="theme-btn t-ocean" onclick="mudarTema('ocean')"></div><span class="theme-label">Ocean</span></div>
                <div class="theme-option-container"><div class="theme-btn t-light" onclick="mudarTema('light')"></div><span class="theme-label">Light</span></div>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:35px 0;">
            <label style="color:var(--text-dim); font-size:0.8rem; font-weight:bold; display:block; margin-bottom:15px;">HARDWARE</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <button class="btn-start" style="margin:0; background:transparent; border:1px solid var(--border); color:var(--text-main);" onclick="reSolicitarMidia()"><i class="fas fa-camera"></i> Resetar Câmera</button>
                <button class="btn-start" style="margin:0; background:transparent; border:1px solid var(--primary); color:var(--primary);" onclick="testarAudio()"><i class="fas fa-volume-up"></i> Testar Fone</button>
            </div>
            <button class="btn-start" style="margin-top:30px;" onclick="fecharConfig()">SALVAR</button>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <main class="main">
            <div class="top-bar">
                <div class="app-logo" style="font-size:1.4rem;"><i class="fas fa-bolt"></i> SQUAD <span>P2P</span></div>
                <div class="controls">
                    <button class="btn-icon" id="btn-cam" onclick="toggleCam()" title="Câmera"><i class="fas fa-video"></i></button>
                    <button class="btn-icon" id="btn-mic" onclick="toggleMic()" title="Microfone"><i class="fas fa-microphone"></i></button>
                    <button class="btn-icon" id="btn-deafen" onclick="toggleDeafen()" title="Áudio"><i class="fas fa-headphones"></i></button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 10px;"></div>
                    <button class="btn-icon" id="btn-share" onclick="startStreamerMode()" title="Compartilhar Tela (PIP)"><i class="fas fa-desktop"></i></button>
                    <button class="btn-icon" id="btn-pip" onclick="togglePiP()" title="Mini Player"><i class="fas fa-external-link-alt"></i></button>
                    <button class="btn-icon" onclick="abrirConfig()" title="Temas"><i class="fas fa-paint-brush"></i></button>
                </div>
                <button class="toggle-chat" onclick="toggleChat()"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="grid" id="video-grid">
                <div class="card" id="my-card">
                    <div class="avatar-view"><img id="my-avatar-display" src="" class="big-avatar"></div>
                    <video id="my-video" autoplay muted></video>
                    <div class="label"><img id="my-mini-avatar" src="" class="mini-avatar"> Você</div>
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="panel">
                <div style="font-size:0.75rem; color:var(--text-dim); font-weight:bold; letter-spacing:1px;">SEU ID PÚBLICO</div>
                <div class="id-container">
                    <div class="id-box" id="my-id">Gerando ID...</div>
                    <button class="btn-copy" onclick="copiarID()" title="Copiar ID"><i class="fas fa-copy"></i></button>
                </div>
                <button class="btn-exit" onclick="sairApp()"><i class="fas fa-sign-out-alt"></i> SAIR / TELA INICIAL</button>
            </div>
            <div class="panel" style="margin-top:-5px;">
                <div style="font-size:0.75rem; color:var(--text-dim); font-weight:bold; letter-spacing:1px; margin-bottom:10px;">ENTRAR NA SALA</div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="target-id" class="modern-input" style="margin:0; font-family:monospace; padding:10px;" placeholder="ID do Amigo...">
                    <button onclick="conectarManual()" style="background:var(--primary); border:none; border-radius:var(--radius); width:50px; cursor:pointer; color:var(--bg-body); font-size:1.1rem; box-shadow:0 0 10px var(--primary-glow);"><i class="fas fa-arrow-right"></i></button>
                </div>
                <button id="btn-reconnect" class="btn-reconnect" onclick="reconectarUltimo()"><i class="fas fa-history"></i> Reconectar Último</button>
            </div>
            <div class="chat-area" id="chat-box">
                <div class="msg" style="text-align:center; opacity:0.6; background:transparent; box-shadow:none;"><small>Histórico não é salvo</small></div>
            </div>
            <div class="chat-input-box">
                <label class="btn-file" title="Enviar Arquivo"><i class="fas fa-paperclip"></i><input type="file" id="fileInput" style="display:none;" onchange="enviarArquivo(this)"></label>
                <input type="text" id="msg-input" style="width:100%; background:transparent; border:none; color:var(--text-main); font-family:var(--font-ui); outline:none;" placeholder="Digite..." onkeypress="enviarMsg(event)">
                <button onclick="enviarMsg({key:'Enter'})" style="background:transparent; border:none; color:var(--primary); cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </aside>
    </div>

<script>
    // --- VARIÁVEIS ---
    let peer = null;
    let localStream = null;  // O que vai para o vídeo e para os amigos (Pode ser Cam ou Mix)
    let camStream = null;    // Sempre a webcam pura
    let myNick = "Batata"; 
    let myAvatar = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
    let peersConectados = {}; 
    let isVideoEnabled = true;
    let isScreenSharing = false;
    const grid = document.getElementById('video-grid');

    // Variáveis do Mixer (Canvas)
    let mixerCanvas = null;
    let mixerCtx = null;
    let screenStreamTemp = null;
    let drawCamOnCanvas = true; // Controla se a cam aparece no PIP

    // --- SETUP VISUAL ---
    function mudarTema(tema) {
        document.documentElement.setAttribute('data-theme', tema);
        localStorage.setItem('squad_theme_v10', tema);
        document.querySelectorAll('.theme-btn').forEach(el => el.classList.remove('selected'));
        document.querySelector(`.t-${tema}`)?.classList.add('selected');
    }
    mudarTema(localStorage.getItem('squad_theme_v10') || 'cyberpunk');

    window.onload = function() {
        const lastId = localStorage.getItem('squad_last_id');
        if(lastId) {
            const btn = document.getElementById('btn-reconnect');
            btn.style.display = 'flex';
            btn.innerHTML = `<i class="fas fa-history"></i> Reconectar (${lastId.substring(0,6)}...)`;
        }
    }

    function carregarAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image(); img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    canvas.width = 150; canvas.height = 150; ctx.drawImage(img, 0, 0, 150, 150);
                    myAvatar = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('avatarPreview').src = myAvatar;
                }; img.src = e.target.result;
            }; reader.readAsDataURL(input.files[0]);
        }
    }

    function iniciarAplicacao() {
        const inputNick = document.getElementById('start-nick').value;
        if(inputNick) myNick = inputNick;
        document.getElementById('my-avatar-display').src = myAvatar;
        document.getElementById('my-mini-avatar').src = myAvatar;
        document.getElementById('loginScreen').style.display = 'none';
        iniciarPeer(); pegarMidiaLocal();
    }

    // --- CORE P2P ---
    function iniciarPeer() {
        peer = new Peer(null, { debug: 1 });
        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', conn => setupDados(conn));
        peer.on('call', call => { call.answer(localStream); setupChamada(call); });
        peer.on('error', err => { if(err.type === 'peer-unavailable') alert("ID não encontrado."); });
    }

    async function pegarMidiaLocal() {
        try {
            // Pega a CAM inicial
            camStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localStream = camStream; // No início, localStream é a própria cam
            document.getElementById('my-video').srcObject = localStream;
        } catch(e) { console.error("Erro Mídia:", e); }
    }

    // --- MODO STREAMER (PIP CANVAS MIXER) ---
    async function startStreamerMode() {
        if(isScreenSharing) { stopStreamerMode(); return; }

        try {
            // 1. Pede a tela (Sem hacks de auto-foco)
            screenStreamTemp = await navigator.mediaDevices.getDisplayMedia({ video: true });
            
            // 2. Prepara elementos invisíveis para o desenho
            const videoTela = document.createElement('video'); videoTela.srcObject = screenStreamTemp; videoTela.muted = true; await videoTela.play();
            const videoCam = document.createElement('video'); videoCam.srcObject = camStream; videoCam.muted = true; await videoCam.play();

            // 3. Cria o Canvas
            mixerCanvas = document.createElement('canvas'); 
            mixerCanvas.width = 1280; mixerCanvas.height = 720; // HD Base
            mixerCtx = mixerCanvas.getContext('2d');

            // 4. Loop de Desenho
            function desenhar() {
                if(!mixerCanvas) return;
                
                // Desenha Tela (Fundo)
                mixerCtx.fillStyle = '#000'; mixerCtx.fillRect(0, 0, mixerCanvas.width, mixerCanvas.height);
                mixerCtx.drawImage(videoTela, 0, 0, mixerCanvas.width, mixerCanvas.height);
                
                // Desenha Webcam (PIP) se estiver ativada
                if(drawCamOnCanvas && isVideoEnabled) {
                    const camW = 320; const camH = 180; const m = 20;
                    mixerCtx.strokeStyle = '#00ff9d'; mixerCtx.lineWidth = 3;
                    mixerCtx.strokeRect(mixerCanvas.width - camW - m, mixerCanvas.height - camH - m, camW, camH);
                    mixerCtx.drawImage(videoCam, mixerCanvas.width - camW - m, mixerCanvas.height - camH - m, camW, camH);
                }
                
                requestAnimationFrame(desenhar);
            }
            desenhar();

            // 5. Gera o Stream do Canvas
            const mixedStream = mixerCanvas.captureStream(30); // 30 FPS para não pesar
            
            // Adiciona o áudio do microfone original
            if(camStream.getAudioTracks().length > 0) mixedStream.addTrack(camStream.getAudioTracks()[0]);

            // 6. Substitui globalmente
            replaceTrackGlobal(mixedStream.getVideoTracks()[0]);
            localStream = mixedStream;
            document.getElementById('my-video').srcObject = mixedStream;
            
            // UI
            document.getElementById('btn-share').classList.add('active-green');
            document.getElementById('my-card').classList.remove('cam-off'); 
            isScreenSharing = true;
            
            // Se parar pelo navegador
            screenStreamTemp.getVideoTracks()[0].onended = () => stopStreamerMode();

        } catch(e) { console.error("Erro Screen:", e); }
    }

    function stopStreamerMode() {
        if(!mixerCanvas) return;
        
        mixerCanvas = null; // Para o loop
        if(screenStreamTemp) screenStreamTemp.getTracks().forEach(t => t.stop());

        // Volta para a webcam pura
        localStream = camStream;
        replaceTrackGlobal(camStream.getVideoTracks()[0]);
        document.getElementById('my-video').srcObject = camStream;
        
        document.getElementById('btn-share').classList.remove('active-green');
        isScreenSharing = false;

        // Se a cam estava desligada antes, volta a ficar preta
        if(!isVideoEnabled) document.getElementById('my-card').classList.add('cam-off');
    }

    function replaceTrackGlobal(newTrack) {
        Object.values(peersConectados).forEach(p => { 
            if(p.call && p.call.peerConnection) {
                const sender = p.call.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                if(sender) sender.replaceTrack(newTrack);
            }
        });
    }

    // --- CONTROLES MÍDIA ---
    function toggleCam() {
        if(!camStream) return;
        isVideoEnabled = !isVideoEnabled;
        
        if(isScreenSharing) {
            // No modo streamer, apenas para de desenhar a cam no canvas
        } else {
            camStream.getVideoTracks()[0].enabled = isVideoEnabled;
            if(isVideoEnabled) document.getElementById('my-card').classList.remove('cam-off');
            else document.getElementById('my-card').classList.add('cam-off');
        }

        const btn = document.getElementById('btn-cam');
        if(isVideoEnabled) btn.classList.remove('active-red');
        else btn.classList.add('active-red');

        Object.values(peersConectados).forEach(p => { if(p.conn?.open) p.conn.send({ type: 'video-state', enabled: isVideoEnabled }); });
    }

    function toggleMic() {
        if(camStream) {
            camStream.getAudioTracks()[0].enabled = !camStream.getAudioTracks()[0].enabled;
            document.getElementById('btn-mic').classList.toggle('active-red');
        }
    }

    function toggleDeafen() {
        document.querySelectorAll('video:not(#my-video)').forEach(v => v.muted = !v.muted);
        document.getElementById('btn-deafen').classList.toggle('active-red');
    }

    // --- CONEXÃO E DADOS ---
    function conectarManual() {
        const id = document.getElementById('target-id').value.trim(); if(!id || id === peer.id) return;
        localStorage.setItem('squad_last_id', id);
        conectarAoPeer(id);
    }
    function reconectarUltimo() {
        const lastId = localStorage.getItem('squad_last_id');
        if(lastId) { document.getElementById('target-id').value = lastId; conectarAoPeer(lastId); }
    }
    function conectarAoPeer(id) {
        const meta = { nick: myNick, avatar: myAvatar };
        const conn = peer.connect(id, { metadata: meta }); setupDados(conn);
        const call = peer.call(id, localStream, { metadata: meta }); setupChamada(call);
    }
    function sairApp() { if(confirm("Sair?")) location.reload(); }

    function setupDados(conn) {
        conn.on('open', () => {
            if(!peersConectados[conn.peer]) peersConectados[conn.peer] = {};
            peersConectados[conn.peer].conn = conn;
            peersConectados[conn.peer].nick = conn.metadata?.nick || "Amigo";
            peersConectados[conn.peer].avatar = conn.metadata?.avatar || myAvatar;
            conn.send({ type: 'update-user', nick: myNick, avatar: myAvatar });
        });
        conn.on('data', data => {
            if(typeof data === 'string') logChat(peersConectados[conn.peer], data, false);
            else if(data.type === 'file') receiveFile(peersConectados[conn.peer], data);
            else if(data.type === 'update-user') {
                peersConectados[conn.peer].nick = data.nick; peersConectados[conn.peer].avatar = data.avatar;
                updateRemoteLabel(conn.peer, data.nick, data.avatar);
            }
        });
    }

    function setupChamada(call) {
        if(!peersConectados[call.peer]) peersConectados[call.peer] = {};
        peersConectados[call.peer].call = call;
        if(call.metadata) { peersConectados[call.peer].nick = call.metadata.nick; peersConectados[call.peer].avatar = call.metadata.avatar; }
        call.on('stream', stream => addVideo(stream, call.peer, peersConectados[call.peer]));
        call.on('close', () => document.getElementById('card-'+call.peer)?.remove());
    }

    // --- ARQUIVOS E CHAT ---
    function enviarArquivo(input) {
        const file = input.files[0]; if(!file) return;
        if(file.size > 3*1024*1024) return alert("Máx 3MB");
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = { type: 'file', name: file.name, fileType: file.type, content: e.target.result };
            Object.values(peersConectados).forEach(p => p.conn.send(data));
            logFile({nick:'Você', avatar:myAvatar}, data, true);
        }; reader.readAsDataURL(file); input.value = '';
    }
    function receiveFile(user, data) { logFile(user, data, false); }
    function logFile(user, data, isMe) {
        let contentHtml = '';
        if(data.fileType.startsWith('image/')) contentHtml = `<img src="${data.content}" class="chat-img" onclick="window.open(this.src)">`;
        else if(data.fileType.startsWith('audio/')) contentHtml = `<audio controls src="${data.content}" class="chat-audio"></audio>`;
        else contentHtml = `<div style="background:rgba(255,255,255,0.1); padding:8px; border-radius:6px; margin-top:5px;">${data.name}</div>`;
        logChat(user, contentHtml, isMe);
    }

    // --- HELPER UI ---
    function addVideo(stream, id, userData) {
        if(document.getElementById('card-'+id)) return;
        const nick = userData?.nick || "Amigo", avatar = userData?.avatar || myAvatar;
        const card = document.createElement('div'); card.className = 'card'; card.id = 'card-'+id;
        card.innerHTML = `<div class="avatar-view"><img src="${avatar}" class="big-avatar"></div><video id="vid-${id}" autoplay></video><div class="label"><img src="${avatar}" class="mini-avatar"> ${nick}</div>`;
        grid.appendChild(card); document.getElementById('vid-'+id).srcObject = stream;
    }
    function updateRemoteLabel(id, nick, avatar) {
        const card = document.getElementById('card-'+id);
        if(card) { card.querySelector('.label').innerHTML = `<img src="${avatar}" class="mini-avatar"> ${nick}`; card.querySelector('.big-avatar').src = avatar; }
    }
    function logChat(userData, content, isMe) {
        const chat = document.getElementById('chat-box');
        chat.innerHTML += `<div class="msg ${isMe?'my-msg':''}"><div class="msg-header"><img src="${userData?.avatar||myAvatar}" style="width:18px;height:18px;border-radius:50%;"> ${userData?.nick||'Amigo'}</div>${content}</div>`;
        chat.scrollTop = chat.scrollHeight;
    }
    function enviarMsg(e) {
        if(e.key === 'Enter') {
            const val = document.getElementById('msg-input').value; if(!val) return;
            Object.values(peersConectados).forEach(p => p.conn.send(val));
            logChat({nick:'Você', avatar:myAvatar}, val, true); document.getElementById('msg-input').value = '';
        }
    }
    
    // --- UTIL ---
    function copierID() { navigator.clipboard.writeText(document.getElementById('my-id').innerText); alert("ID Copiado!"); }
    function abrirConfig() { document.getElementById('configScreen').style.display = 'flex'; }
    function fecharConfig() { document.getElementById('configScreen').style.display = 'none'; }
    async function reSolicitarMidia() { if(camStream) camStream.getTracks().forEach(t=>t.stop()); await pegarMidiaLocal(); fecharConfig(); }
    function testarAudio() { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); o.connect(ctx.destination); o.start(); setTimeout(()=>o.stop(),500); }
    async function togglePiP() { const v = document.querySelector('.grid video:not(#my-video)')||document.getElementById('my-video'); if(document.pictureInPictureElement)document.exitPictureInPicture(); else if(v&&v.readyState>=1) await v.requestPictureInPicture(); }

</script>
</body>
</html>